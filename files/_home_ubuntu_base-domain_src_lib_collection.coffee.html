<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/home/ubuntu/base-domain/src/lib/collection.coffee - base-domain</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="base-domain"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AggregateRoot.html">AggregateRoot</a></li>
            
                <li><a href="../classes/Base.html">Base</a></li>
            
                <li><a href="../classes/BaseAsyncRepository.html">BaseAsyncRepository</a></li>
            
                <li><a href="../classes/BaseDict.html">BaseDict</a></li>
            
                <li><a href="../classes/BaseFactory.html">BaseFactory</a></li>
            
                <li><a href="../classes/BaseList.html">BaseList</a></li>
            
                <li><a href="../classes/BaseModel.html">BaseModel</a></li>
            
                <li><a href="../classes/BaseModule.html">BaseModule</a></li>
            
                <li><a href="../classes/BaseRepository.html">BaseRepository</a></li>
            
                <li><a href="../classes/BaseService.html">BaseService</a></li>
            
                <li><a href="../classes/BaseSyncRepository.html">BaseSyncRepository</a></li>
            
                <li><a href="../classes/Collection.html">Collection</a></li>
            
                <li><a href="../classes/DomainError.html">DomainError</a></li>
            
                <li><a href="../classes/Entity.html">Entity</a></li>
            
                <li><a href="../classes/EntityCollectionIncluder.html">EntityCollectionIncluder</a></li>
            
                <li><a href="../classes/EntityPool.html">EntityPool</a></li>
            
                <li><a href="../classes/Facade.html">Facade</a></li>
            
                <li><a href="../classes/FactoryInterface.html">FactoryInterface</a></li>
            
                <li><a href="../classes/Fixture.html">Fixture</a></li>
            
                <li><a href="../classes/FixtureLoader.html">FixtureLoader</a></li>
            
                <li><a href="../classes/GeneralFactory.html">GeneralFactory</a></li>
            
                <li><a href="../classes/Includer.html">Includer</a></li>
            
                <li><a href="../classes/LocalRepository.html">LocalRepository</a></li>
            
                <li><a href="../classes/MasterDataResource.html">MasterDataResource</a></li>
            
                <li><a href="../classes/MasterRepository.html">MasterRepository</a></li>
            
                <li><a href="../classes/MemoryResource.html">MemoryResource</a></li>
            
                <li><a href="../classes/ModelProps.html">ModelProps</a></li>
            
                <li><a href="../classes/ResourceClientInterface.html">ResourceClientInterface</a></li>
            
                <li><a href="../classes/RootInterface.html">RootInterface</a></li>
            
                <li><a href="../classes/Scope.html">Scope</a></li>
            
                <li><a href="../classes/TypeInfo.html">TypeInfo</a></li>
            
                <li><a href="../classes/ValueObject.html">ValueObject</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/base-domain.html">base-domain</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /home/ubuntu/base-domain/src/lib/collection.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;

ValueObject = require &#x27;./value-object&#x27;
EntityPool = require &#x27;../entity-pool&#x27;
BaseModel = require &#x27;./base-model&#x27;
Util = require &#x27;../util&#x27;

###*
collection model of one model

@class Collection
@extends ValueObject
@module base-domain
###
class Collection extends ValueObject

    ###*
    model name of the item

    @property itemModelName
    @static
    @protected
    @type String
    ###
    @itemModelName: null


    ###*
    the number of items (or ids when @isItemEntity is true)

    @property {Number} length
    @public
    ###
    Object.defineProperty @::, &#x27;length&#x27;,
        get: -&gt;
            if @isItemEntity
                return @ids.length
            else
                return @itemLength



    ###*
    items (submodel collection)

    @property {Object} items
    @abstract
    ###


    ###*
    @constructor
    @params {any} props
    @params {RootInterface} root
    ###
    constructor: (props = {}, root) -&gt;

        @setRoot(root)

        if not @constructor.itemModelName?
            throw @error &#x27;base-domain:itemModelNameRequired&#x27;, &quot;@itemModelName is not set, in class #{@constructor.name}&quot;

        _itemFactory = null
        isItemEntity = @facade.getModel(@constructor.itemModelName).isEntity

        Object.defineProperties @,

            ###*
            item factory
            Created only one time. Be careful that @root is not changed even the collection&#x27;s root is changed.

            @property {FactoryInterface} itemFactory
            ###
            itemFactory:
                get: -&gt; _itemFactory ?= require(&#x27;./general-factory&#x27;).create(@constructor.itemModelName, @root)

            isItemEntity:
                value: isItemEntity, writable: false


        @clear()

        if props.ids? and props.items
            { ids } = props
            delete props.ids
            super(props, root)
            props.ids = ids
        else
            super(props, root)


    ###*
    Get the copy of ids
    @return {Array(String)} ids
    ###
    getIds: -&gt;
        return undefined if not @isItemEntity

        return @ids?.slice()


    ###*
    set value to prop
    @return {BaseModel} this
    ###
    set: (k, v) -&gt;
        switch k
            when &#x27;items&#x27;
                @setItems v
            when &#x27;ids&#x27;
                @setIds v
            else
                super
        return @


    ###*
    add new submodel to item(s)

    @method add
    @public
    @param {BaseModel|Object} ...items
    ###
    add: (items...) -&gt;
        @addItems(items)


    ###*
    add submodels and create new collection

    @method add
    @public
    @param {BaseModel|Object} ...items
    @return {Collection}
    ###
    $add: (items...) -&gt;
        newItems = @toArray().concat(items)
        return @copyWith(items: newItems)


    ###*
    @method addItems
    @param {Object|Array(BaseModel|Object)} items
    @protected
    ###
    addItems: (items = []) -&gt;

        @initItems() if not @loaded()

        factory = @itemFactory

        for key, item of items
            @addItem(factory.createFromObject item)

        if @isItemEntity
            @ids = (item.id for item in @toArray())


    ###*
    add item to @items

    @method addItem
    @protected
    @abstract
    @param {BaseModel} item
    ###
    addItem: (item) -&gt;


    ###*
    clear and set ids.

    @method setIds
    @param {Array(String|Number)} ids
    @chainable
    ###
    setIds: (ids = []) -&gt;

        return if not @isItemEntity
        return if not Array.isArray ids

        @clear()
        @ids = ids


    ###*
    clear and add items

    @method setItems
    @param {Object|Array(BaseModel|Object)} items
    ###
    setItems: (items = []) -&gt;

        @clear()
        @addItems(items)

        return @


    ###*
    removes all items and ids

    @method clear
    ###
    clear: -&gt;
        delete @items
        if @isItemEntity
            @ids = []

    ###*
    removes all items and create a new collection

    @method clear
    ###
    $clear: -&gt;
        @copyWith(items: [])


    ###*
    export items to Array

    @method toArray
    @public
    @abstract
    @return {Array}
    ###
    toArray: -&gt;


    ###*
    Execute given function for each item

    @method forEach
    @public
    @param {Function} fn
    @param {Object} _this
    ###
    forEach: (fn, _this) -&gt;
        @map(fn, _this)
        return

    ###*
    Execute given function for each item
    returns an array of the result

    @method map
    @public
    @param {Function} fn
    @param {Object} _this
    @return {Array}
    ###
    map: (fn, _this) -&gt;
        _this ?= @
        return [] if typeof fn isnt &#x27;function&#x27;
        (fn.call(_this, item) for item in @toArray())


    ###*
    Filter items with given function

    @method filter
    @public
    @param {Function} fn
    @param {Object} _this
    @return {Array}
    ###
    filter: (fn, _this) -&gt;
        _this ?= @
        return @toArray() if typeof fn isnt &#x27;function&#x27;
        @toArray().filter(fn, _this)


    ###*
    Returns if some items match the condition in given function

    @method some
    @public
    @param {Function} fn
    @param {Object} _this
    @return {Boolean}
    ###
    some: (fn, _this) -&gt;
        _this ?= @
        return false if typeof fn isnt &#x27;function&#x27;
        @toArray().some(fn, _this)


    ###*
    Returns if every items match the condition in given function

    @method every
    @public
    @param {Function} fn
    @param {Object} _this
    @return {Boolean}
    ###
    every: (fn, _this) -&gt;
        _this ?= @
        return false if typeof fn isnt &#x27;function&#x27;
        @toArray().every(fn, _this)



    initItems: -&gt;


    ###*
    include all relational models if not set

    @method include
    @param {Object} [options]
    @param {Boolean} [options.async=true] get async values
    @param {Array(String)} [options.props] include only given props
    @return {Promise(BaseModel)} self
    ###
    include: (options = {}) -&gt;

        options.entityPool ?= new EntityPool

        superResult = super(options)

        return superResult if not @isItemEntity

        return @includeEntityItems(options, superResult)


    includeEntityItems: (options, superResult) -&gt;

        EntityCollectionIncluder = require &#x27;./entity-collection-includer&#x27;

        Promise.all([
            superResult
            new EntityCollectionIncluder(@, options).include()
        ]).then =&gt; @


    ###*
    freeze the model
    ###
    freeze: -&gt;
        throw @error(&#x27;FreezeMutableModel&#x27;, &#x27;Cannot freeze mutable model.&#x27;) if not @constructor.isImmutable
        if @loaded
            Object.freeze(@items)
            return Object.freeze(@)
        else
            return @include().then =&gt;
                Object.freeze(@items)
                return Object.freeze(@)



    ###*
    create plain object.
    if this dict contains entities, returns their ids
    if this dict contains non-entity models, returns their plain objects

    @method toPlainObject
    @return {Object} plainObject
    ###
    toPlainObject: -&gt;

        plain = super()

        if @isItemEntity
            plain.ids = @ids.slice()
            delete plain.items

        else if @loaded()

            plainItems = for key, item of @items
                if typeof item.toPlainObject is &#x27;function&#x27;
                    item.toPlainObject()
                else
                    item

            plain.items = plainItems

        return plain


    ###*
    create plain array.

    @method toPlainArray
    @return {Array} plainArray
    ###
    toPlainArray: -&gt;

        if @isItemEntity
            return @ids.slice()

        else if @loaded()
            items = []
            for key, item of @items
                if typeof item.toPlainObject is &#x27;function&#x27;
                    items.push item.toPlainObject()
                else
                    items.push item
            return items
        else
            return []

    ###*
    clone the model as a plain object

    @method clone
    @return {BaseModel}
    ###
    plainClone: -&gt;

        plain = super()

        if @loaded()
            plain.items = for key, item of @items
                if item instanceof BaseModel
                    item.plainClone()
                else
                    item

        return plain


    ###*
    @method loaded
    @public
    @return {Boolean}
    ###
    loaded: -&gt; @items?


    ###*
    get item model
    @method getItemModelClass
    @return {Function}
    ###
    getItemModelClass: -&gt;
        @facade.getModel(@constructor.itemModelName)


    getDiffProps: (plainObj = {}) -&gt;
        thatObj = {}

        if Array.isArray(plainObj)
            if plainObj.length is 0
                thatObj.items = []
            else if typeof plainObj[0] is &#x27;object&#x27;
                thatObj.items = plainObj
            else
                thatObj.ids = plainObj
        else
            thatObj = plainObj

        ret = super(thatObj)

        if @isItemEntity and thatObj.ids
            ret.push(&#x27;ids&#x27;) if @isIdsDifferent(thatObj.ids)
            return ret

        else if @isItemsDifferent(thatObj.items)
            ret.push(&#x27;items&#x27;)
            return ret

        return ret


    isItemsDifferent: (items) -&gt;
        return @itemLength &gt; 0 if not Array.isArray(items)
        return true if @itemLength isnt items.length

        return @some (item, i) -&gt;
            if typeof item.isDifferentFrom is &#x27;function&#x27;
                item.isDifferentFrom(items[i])
            else
                not Util.deepEqual(item, items[i])

    isIdsDifferent: (ids) -&gt;
        return @length &gt; 0 if not Array.isArray(ids)
        return not Util.deepEqual(@ids, ids)

module.exports = Collection

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
