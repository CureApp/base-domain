<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/home/ubuntu/base-domain/src/lib/facade.coffee - base-domain</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="base-domain"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AggregateRoot.html">AggregateRoot</a></li>
            
                <li><a href="../classes/Base.html">Base</a></li>
            
                <li><a href="../classes/BaseAsyncRepository.html">BaseAsyncRepository</a></li>
            
                <li><a href="../classes/BaseDict.html">BaseDict</a></li>
            
                <li><a href="../classes/BaseFactory.html">BaseFactory</a></li>
            
                <li><a href="../classes/BaseList.html">BaseList</a></li>
            
                <li><a href="../classes/BaseModel.html">BaseModel</a></li>
            
                <li><a href="../classes/BaseModule.html">BaseModule</a></li>
            
                <li><a href="../classes/BaseRepository.html">BaseRepository</a></li>
            
                <li><a href="../classes/BaseService.html">BaseService</a></li>
            
                <li><a href="../classes/BaseSyncRepository.html">BaseSyncRepository</a></li>
            
                <li><a href="../classes/Collection.html">Collection</a></li>
            
                <li><a href="../classes/DomainError.html">DomainError</a></li>
            
                <li><a href="../classes/Entity.html">Entity</a></li>
            
                <li><a href="../classes/EntityCollectionIncluder.html">EntityCollectionIncluder</a></li>
            
                <li><a href="../classes/EntityPool.html">EntityPool</a></li>
            
                <li><a href="../classes/Facade.html">Facade</a></li>
            
                <li><a href="../classes/FactoryInterface.html">FactoryInterface</a></li>
            
                <li><a href="../classes/Fixture.html">Fixture</a></li>
            
                <li><a href="../classes/FixtureLoader.html">FixtureLoader</a></li>
            
                <li><a href="../classes/GeneralFactory.html">GeneralFactory</a></li>
            
                <li><a href="../classes/Includer.html">Includer</a></li>
            
                <li><a href="../classes/LocalRepository.html">LocalRepository</a></li>
            
                <li><a href="../classes/MasterDataResource.html">MasterDataResource</a></li>
            
                <li><a href="../classes/MasterRepository.html">MasterRepository</a></li>
            
                <li><a href="../classes/MemoryResource.html">MemoryResource</a></li>
            
                <li><a href="../classes/ModelProps.html">ModelProps</a></li>
            
                <li><a href="../classes/ResourceClientInterface.html">ResourceClientInterface</a></li>
            
                <li><a href="../classes/RootInterface.html">RootInterface</a></li>
            
                <li><a href="../classes/Scope.html">Scope</a></li>
            
                <li><a href="../classes/TypeInfo.html">TypeInfo</a></li>
            
                <li><a href="../classes/ValueObject.html">ValueObject</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/base-domain.html">base-domain</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /home/ubuntu/base-domain/src/lib/facade.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;

Util = require &#x27;../util&#x27;

GeneralFactory = require &#x27;./general-factory&#x27;
MasterDataResource = require &#x27;../master-data-resource&#x27;
ModelProps = require &#x27;./model-props&#x27;
BaseModel  = require &#x27;./base-model&#x27;
BaseModule = require &#x27;./base-module&#x27;
CoreModule = require &#x27;./core-module&#x27;

###*
Facade class of DDD pattern.

- create instance of factories
- create instance of repositories

@class Facade
@implements RootInterface
@module base-domain
###
class Facade

    ###*
    is root (to identify RootInterface)
    @property {Boolean} isRoot
    @static
    ###
    @isRoot: true


    ###*
    Get facade

    @deprecated just use this.facade
    @method getFacade
    @return {Facade}
    @chainable
    ###
    getFacade: -&gt; @


    ###*
    Latest instance created via @createInstance()
    This instance will be attached base instances with no @root property.

    @property {Facade} latestInstance
    @static
    ###
    @latestInstance: null


    ###*
    create instance of Facade

    @method createInstance
    @static
    @param {Object} [options]
    @return {Facade}
    ###
    @createInstance: (options = {}) -&gt;
        Constructor = @
        instance = new Constructor(options)
        Facade.latestInstance = instance
        return instance


    ###*
    constructor

    @constructor
    @param {String} [options]
    @param {String} [options.dirname=&quot;.&quot;] path where domain definition files are included
    @param {Object} [options.preferred={}]
    @param {Object} [options.preferred.repository] key: firstName, value: repository name used in facade.createPreferredRepository(firstName)
    @param {Object} [options.preferred.factory] key: firstName, value: factory name used in facade.createPreferredFactory(firstName)
    @param {Object} [options.preferred.service] key: firstName, value: service name used in facade.createPreferredService(firstName)
    @param {String|Array(String)} [options.preferred.module] module prefix attached to load preferred class
    @param {Boolean} [options.master] if true, MasterDataResource is enabled.
    ###
    constructor: (options = {}) -&gt;

        Object.defineProperties @,
            facade: value: @
            nonExistingClassNames: value: {}
            classes   : value: {}
            modelProps: value: {}
            modules   : value: {}
            preferred : value:
                repository : Util.clone(options.preferred?.repository) ? {}
                factory    : Util.clone(options.preferred?.factory) ? {}
                service    : Util.clone(options.preferred?.service) ? {}
                module     : options.preferred?.module

        @dirname = options.dirname ? &#x27;.&#x27;

        for moduleName, path of Util.clone(options.modules ? {})
            @modules[moduleName] = new BaseModule(moduleName, path, @)
        throw @error(&#x27;invalidModuleName&#x27;, &#x27;Cannot use &quot;core&quot; as a module name&#x27;) if @modules.core

        @modules.core = new CoreModule(@dirname, @)

        if options.master
            ###*
            instance of MasterDataResource
            Exist only when &quot;master&quot; property is given to Facade&#x27;s option

            @property {MasterDataResource} master
            @optional
            @readOnly
            ###
            @master = new MasterDataResource(@)

        @init()
        @master?.init()


    # for entry-generator, keep it empty
    init: -&gt;

    initWithPacked: (packed) -&gt;
        { masterData, core, modules, factories } = packed

        if masterData and not @master?
            @master = new MasterDataResource(@)

        @master?.init = -&gt; @initWithData(masterData)

        for klassName, klass of core
            this.addClass(klassName, klass)

        for moduleName, klasses of modules
            for klassName, klass of klasses
                this.addClass(moduleName + &#x27;/&#x27; + klassName, klass)

        for modelName, factoryName of (factories ? {})
            if not factoryName?
                @nonExistingClassNames[modelName + &#x27;-factory&#x27;] = true

        return @


    ###*
    get a model class

    @method getModel
    @param {String} firstName
    @return {Function}
    ###
    getModel: (firstName) -&gt;
        return @require(firstName)


    ###*
    Create instance of given Class.

    @method create
    @param {Function|Class} Class
    @return {Base}
    ###
    create: (Class, params...) -&gt;
        if (Class::) instanceof BaseModel
            try
                return @createModel(Class.className, params...)
            catch e
                throw @error(e.reason, e.message) # to avoid deeper stack

        ClassWithConstructor = Class

        while ClassWithConstructor.length is 0 and ClassWithConstructor isnt Object
            ClassWithConstructor = Util.getProto(ClassWithConstructor::).constructor

        while params.length &lt; ClassWithConstructor.length - 1
            params.push undefined

        # return new Class(params..., root ? @)
        # workaround for ES6 classes, which cannot be invoked without &quot;new&quot;
        switch params.length
            when 0
                return new Class(@)
            when 1
                return new Class(params[0], @)
            when 2
                return new Class(params[0], params[1], @)
            when 3
                return new Class(params[0], params[1], params[2], @)
            when 4
                return new Class(params[0], params[1], params[2], params[3], @)
            when 5
                return new Class(params[0], params[1], params[2], params[3], params[4], @)
            when 6
                return new Class(params[0], params[1], params[2], params[3], params[4], params[5], @)
            else
                return new Class(params..., @)



    ###*
    create an instance of the given modFirstName using obj
    if obj is null or undefined, empty object will be created.

    @method createModel
    @param {String} modFirstName
    @param {Object} obj
    @param {Object} [options]
    @param {RootInterface} [root]
    @return {BaseModel}
    ###
    createModel: (modFirstName, obj, options, root) -&gt;
        GeneralFactory.createModel(modFirstName, obj, options, root ? @)


    ###*
    create a factory instance
    2nd, 3rd, 4th ... arguments are the params to pass to the constructor of the factory

    @method createFactory
    @param {String} modFirstName
    @return {BaseFactory}
    ###
    createFactory: (modFirstName, params...) -&gt;
        @__create(modFirstName, &#x27;factory&#x27;, params, @)


    ###*
    create a repository instance
    2nd, 3rd, 4th ... arguments are the params to pass to the constructor of the repository

    @method createRepository
    @param {String} modFirstName
    @return {BaseRepository}
    ###
    createRepository: (modFirstName, params...) -&gt;
        @__create(modFirstName, &#x27;repository&#x27;, params, @)


    ###*
    create a service instance
    2nd, 3rd, 4th ... arguments are the params to pass to the constructor of the service

    @method createService
    @param {String} modFirstName
    @return {BaseService}
    ###
    createService: (modFirstName, params...) -&gt;
        @__create(modFirstName, &#x27;service&#x27;, params, @)


    __create: (modFirstName, type, params, root) -&gt;

        modFullName = if type then modFirstName + &#x27;-&#x27; + type else modFirstName

        Class = ClassWithConstructor = @require(modFullName)

        while ClassWithConstructor.length is 0 and ClassWithConstructor isnt Object
            ClassWithConstructor = Util.getProto(ClassWithConstructor::).constructor

        while params.length &lt; ClassWithConstructor.length - 1
            params.push undefined

        # return new Class(params..., root ? @)
        # workaround for ES6 classes, which cannot be invoked without &quot;new&quot;
        switch params.length
            when 0
                return new Class(root ? @)
            when 1
                return new Class(params[0], root ? @)
            when 2
                return new Class(params[0], params[1], root ? @)
            when 3
                return new Class(params[0], params[1], params[2], root ? @)
            when 4
                return new Class(params[0], params[1], params[2], params[3], root ? @)
            when 5
                return new Class(params[0], params[1], params[2], params[3], params[4], root ? @)
            when 6
                return new Class(params[0], params[1], params[2], params[3], params[4], params[5], root ? @)
            else
                return new Class(params..., root ? @)


    ###*
    create a preferred repository instance
    3rd, 4th ... arguments are the params to pass to the constructor of the repository

    @method createPreferredRepository
    @param {String} firstName
    @param {Object} [options]
    @param {Object} [options.noParent] if true, stop requiring parent class
    @return {BaseRepository}
    ###
    createPreferredRepository: (firstName, options, params...) -&gt;

        @createPreferred(firstName, &#x27;repository&#x27;, options, params, @)


    ###*
    create a preferred factory instance
    3rd, 4th ... arguments are the params to pass to the constructor of the factory

    @method createPreferredFactory
    @param {String} firstName
    @param {Object} [options]
    @param {Object} [options.noParent=true] if true, stop requiring parent class
    @return {BaseFactory}
    ###
    createPreferredFactory: (firstName, options = {}, params...) -&gt;

        options.noParent ?= true

        @createPreferred(firstName, &#x27;factory&#x27;, options, params, @)


    ###*
    create a preferred service instance
    2nd, 3rd, 4th ... arguments are the params to pass to the constructor of the factory

    @method createPreferredService
    @param {String} firstName
    @param {Object} [options]
    @param {Object} [options.noParent=true] if true, stop requiring parent class
    @return {BaseService}
    ###
    createPreferredService: (firstName, options = {}, params...) -&gt;

        options.noParent ?= true

        @createPreferred(firstName, &#x27;service&#x27;, options, params, @)


    ###*
    create a preferred factory|repository|service instance

    @method createPreferred
    @private
    @param {String} modFirstName
    @param {String} type factory|repository|service
    @param {Object} [options]
    @param {Object} [params] params pass to constructor of Repository, Factory or Service
    @param {RootInterface} root
    @return {BaseFactory}
    ###
    createPreferred: (modFirstName, type, options = {}, params, root) -&gt;

        originalFirstName = modFirstName

        for modFullName in @getPreferredNames(modFirstName, type)
            return @__create(modFullName, null, params, root) if @hasClass(modFullName)

        if not options.noParent
            ParentClass = @require(modFirstName).getParent()
            if ParentClass.className
                return @createPreferred(ParentClass.getName(), type, options, params, root)

        throw @error(&quot;preferred#{type}NotFound&quot;, &quot;preferred #{type} of &#x27;#{originalFirstName}&#x27; is not found&quot;)


    ###*
    @method getPreferredNames
    @private
    @param {String} modFirstName
    @param {String} type repository|factory|service
    @return {String} modFullName
    ###
    getPreferredNames: (modFirstName, type) -&gt;

        specific = @preferred[type][modFirstName]

        names = [@preferred.module, @moduleName(modFirstName), &#x27;core&#x27;] # FIXME: make it unique
            .filter (v) -&gt; v
            .map (moduleName) =&gt;
                @getModule(moduleName).normalizeName(modFirstName + &#x27;-&#x27; + type)

        names.unshift specific if specific

        return names


    ###*
    read a file and returns class

    @method require
    @private
    @param {String} modFullName
    @return {Function}
    ###
    require: (modFullName_o) -&gt;

        modFullName = @getModule().normalizeName(modFullName_o)
        return @classes[modFullName] if @classes[modFullName]?

        moduleName = @moduleName(modFullName)
        fullName   = @fullName(modFullName)

        if not @nonExistingClassNames[modFullName] # avoid searching non-existing files many times
            mod = @getModule(moduleName)
            throw @error(&#x27;moduleNotFound&#x27;, &quot;module &#x27;#{moduleName}&#x27; is not found (requiring &#x27;#{fullName}&#x27;)&quot;) if not mod?
            klass = mod.requireOwn(fullName)

        if not klass?
            @nonExistingClassNames[modFullName] = true

            modFullName = fullName # strip module name
            klass = @classes[fullName] or @getModule().requireOwn(fullName)

        if not klass?
            @nonExistingClassNames[fullName] = true
            throw @error(&#x27;modelNotFound&#x27;, &quot;model &#x27;#{modFullName_o}&#x27; is not found&quot;)

        @nonExistingClassNames[modFullName] = false
        @addClass modFullName, klass


    ###*
    @method getModule
    @param {String} moduleName
    @return {BaseModule}
    ###
    getModule: (moduleName = &#x27;core&#x27;) -&gt;
        @modules[moduleName]


    ###*
    get moduleName from modFullName
    @method moduleName
    @private
    @param {String} modFullName
    @return {String}
    ###
    moduleName: (modFullName) -&gt;
        if modFullName.match &#x27;/&#x27; then modFullName.split(&#x27;/&#x27;)[0] else &#x27;core&#x27;


    ###*
    get fullName from modFullName
    @method fullName
    @private
    @param {String} modFullName
    @return {String}
    ###
    fullName: (modFullName) -&gt;
        if modFullName.match &#x27;/&#x27; then modFullName.split(&#x27;/&#x27;)[1] else modFullName


    ###*
    Serialize the given object containing model information

    @method serialize
    @param {any} val
    @return {String}
    ###
    serialize: (val) -&gt;
        Util.serialize val


    ###*
    Deserializes serialized string

    @method deserialize
    @param {String} str
    @return {any}
    ###
    deserialize: (str) -&gt;
        Util.deserialize str, @


    ###*
    check existence of the class of the given name

    @method hasClass
    @param {String} modFullName
    @return {Function}
    ###
    hasClass: (modFullName) -&gt;

        modFullName = @getModule().normalizeName(modFullName)

        return false if @nonExistingClassNames[modFullName]

        try
            @require(modFullName)
            return true
        catch e
            return false


    ###*
    add class to facade.
    the class is acquired by @require(modFullName)

    @method addClass
    @private
    @param {String} modFullName
    @param {Function} klass
    @return {Function}
    ###
    addClass: (modFullName, klass) -&gt;

        modFullName = @getModule().normalizeName(modFullName)

        klass.className = modFullName
        klass.moduleName = @moduleName(modFullName)

        delete @nonExistingClassNames[modFullName]

        @classes[modFullName] = klass


    ###*
    Get ModelProps by firstName.
    ModelProps summarizes properties of this class

    @method getModelProps
    @param {String} modFullName
    @return {ModelProps}
    ###
    getModelProps: (modFullName) -&gt;

        if not @modelProps[modFullName]?

            Model = @getModel(modFullName)

            @modelProps[modFullName] = new ModelProps(modFullName, Model.properties, @getModule(@moduleName modFullName))

        return @modelProps[modFullName]

    ###*
    create instance of DomainError

    @method error
    @param {String} reason reason of the error
    @param {String} [message]
    @return {Error}
    ###
    error: (reason, message) -&gt;

        DomainError = @constructor.DomainError
        return new DomainError(reason, message)


    ###*
    check if given object is instance of DomainError

    @method isDomainError
    @param {Error} e
    @return {Boolean}
    ###
    isDomainError: (e) -&gt;

        DomainError = @constructor.DomainError
        return e instanceof DomainError


    ###*
    insert fixture data
    (Node.js only)

    @method insertFixtures
    @param {Object} [options]
    @param {String} [options.dataDir=&#x27;./data&#x27;] directory to have fixture data files
    @param {String} [options.tsvDir=&#x27;./tsv&#x27;] directory to have TSV files
    @param {Array(String)} [options.models=null] model firstNames to insert. default: all models
    @return {Promise(EntityPool)} inserted data
    ###
    insertFixtures: (options = {}) -&gt;

        Fixture = require &#x27;../fixture&#x27;
        fixture = new Fixture(@, options)
        fixture.insert(options.models)


    @Base                : require &#x27;./base&#x27;
    @BaseModel           : require &#x27;./base-model&#x27;
    @BaseService         : require &#x27;./base-service&#x27;
    @ValueObject         : require &#x27;./value-object&#x27;
    @Entity              : require &#x27;./entity&#x27;
    @AggregateRoot       : require &#x27;./aggregate-root&#x27;
    @Collection          : require &#x27;./collection&#x27;
    @BaseList            : require &#x27;./base-list&#x27;
    @BaseDict            : require &#x27;./base-dict&#x27;
    @BaseFactory         : require &#x27;./base-factory&#x27;
    @BaseRepository      : require &#x27;./base-repository&#x27;
    @BaseSyncRepository  : require &#x27;./base-sync-repository&#x27;
    @BaseAsyncRepository : require &#x27;./base-async-repository&#x27;
    @LocalRepository     : require &#x27;./local-repository&#x27;
    @MasterRepository    : require &#x27;./master-repository&#x27;
    @DomainError         : require &#x27;./domain-error&#x27;
    @GeneralFactory      : require &#x27;./general-factory&#x27;


module.exports = Facade

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
