<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/home/ubuntu/base-domain/src/lib/general-factory.coffee - base-domain</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="base-domain"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AggregateRoot.html">AggregateRoot</a></li>
            
                <li><a href="../classes/Base.html">Base</a></li>
            
                <li><a href="../classes/BaseAsyncRepository.html">BaseAsyncRepository</a></li>
            
                <li><a href="../classes/BaseDict.html">BaseDict</a></li>
            
                <li><a href="../classes/BaseFactory.html">BaseFactory</a></li>
            
                <li><a href="../classes/BaseList.html">BaseList</a></li>
            
                <li><a href="../classes/BaseModel.html">BaseModel</a></li>
            
                <li><a href="../classes/BaseModule.html">BaseModule</a></li>
            
                <li><a href="../classes/BaseRepository.html">BaseRepository</a></li>
            
                <li><a href="../classes/BaseService.html">BaseService</a></li>
            
                <li><a href="../classes/BaseSyncRepository.html">BaseSyncRepository</a></li>
            
                <li><a href="../classes/Collection.html">Collection</a></li>
            
                <li><a href="../classes/DomainError.html">DomainError</a></li>
            
                <li><a href="../classes/Entity.html">Entity</a></li>
            
                <li><a href="../classes/EntityCollectionIncluder.html">EntityCollectionIncluder</a></li>
            
                <li><a href="../classes/EntityPool.html">EntityPool</a></li>
            
                <li><a href="../classes/Facade.html">Facade</a></li>
            
                <li><a href="../classes/FactoryInterface.html">FactoryInterface</a></li>
            
                <li><a href="../classes/Fixture.html">Fixture</a></li>
            
                <li><a href="../classes/FixtureLoader.html">FixtureLoader</a></li>
            
                <li><a href="../classes/GeneralFactory.html">GeneralFactory</a></li>
            
                <li><a href="../classes/Includer.html">Includer</a></li>
            
                <li><a href="../classes/LocalRepository.html">LocalRepository</a></li>
            
                <li><a href="../classes/MasterDataResource.html">MasterDataResource</a></li>
            
                <li><a href="../classes/MasterRepository.html">MasterRepository</a></li>
            
                <li><a href="../classes/MemoryResource.html">MemoryResource</a></li>
            
                <li><a href="../classes/ModelProps.html">ModelProps</a></li>
            
                <li><a href="../classes/ResourceClientInterface.html">ResourceClientInterface</a></li>
            
                <li><a href="../classes/RootInterface.html">RootInterface</a></li>
            
                <li><a href="../classes/Scope.html">Scope</a></li>
            
                <li><a href="../classes/TypeInfo.html">TypeInfo</a></li>
            
                <li><a href="../classes/ValueObject.html">ValueObject</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/base-domain.html">base-domain</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /home/ubuntu/base-domain/src/lib/general-factory.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;

BaseList = require &#x27;./base-list&#x27;
BaseDict = require &#x27;./base-dict&#x27;
Util = require &#x27;../util&#x27;

###*
general factory class

create instance of model

@class GeneralFactory
@implements FactoryInterface
@module base-domain
###
class GeneralFactory

    ###*
    create a factory.
    If specific factory is defined, return the instance.
    Otherwise, return instance of GeneralFactory.
    This method is not suitable for creating collections, thus only called by Repository, which handles Entity (= non-collection).

    @method create
    @static
    @param {String} modelName
    @param {RootInterface} root
    @return {FactoryInterface}
    ###
    @create: (modelName, root) -&gt;

        try
            return root.createPreferredFactory(modelName) # TODO: enable to pass 2nd arguement (noParent: boolean)

        catch e
            return new GeneralFactory(modelName, root)


    ###*
    create an instance of the given modelName using obj
    if obj is null, return null
    if obj is undefined, empty object is created.

    @method createModel
    @param {String} modelName
    @param {Object} obj
    @param {Object} [options]
    @param {Object} [options.include] options to pass to Includer
    @param {Object} [options.include.async=false] include sub-entities asynchronously if true.
    @param {Array(String)} [options.include.props] include sub-entities of given props
    @param {RootInterface} root
    @return {BaseModel}
    ###
    @createModel: (modelName, obj, options, root) -&gt;

        return null if obj is null

        Model = root.getModule().getModel(modelName)

        if (Model::) instanceof BaseList
            return @create(Model.itemModelName, root).createList(modelName, obj, options)

        else if (Model::) instanceof BaseDict
            return @create(Model.itemModelName, root).createDict(modelName, obj, options)

        else
            return @create(modelName, root).createFromObject(obj ? {}, options)


    ###*
    constructor

    @constructor
    @param {String} modelName
    @param {RootInterface} root
    ###
    constructor: (@modelName, @root) -&gt;
        @facade = @root.facade
        @modelProps = @facade.getModelProps(@root.getModule().normalizeName @modelName)


    ###*
    get model class this factory handles

    @method getModelClass
    @return {Function}
    ###
    getModelClass: -&gt;
        @root.getModule().getModel(@modelName)


    ###*
    create empty model instance

    @method createEmpty
    @public
    @return {BaseModel}
    ###
    createEmpty: -&gt; @createFromObject({})

    ###*
    create instance of model class by plain object

    for each prop, values are set by Model#set(prop, value)

    @method createFromObject
    @public
    @param {Object} obj
    @param {Object} [options={}]
    @param {Object} [options.include] options to pass to Includer
    @param {Object} [options.include.async=false] include sub-entities asynchronously if true.
    @param {Array(String)} [options.include.props] include sub-entities of given props
    @return {BaseModel} model
    ###
    createFromObject: (obj, options = {}) -&gt;

        ModelClass = @getModelClass()

        return obj if obj instanceof ModelClass

        if not obj? or typeof obj isnt &#x27;object&#x27;
            return null

        model = @create()

        # setting values to the model
        for own prop, value of obj

            continue if not value? and @modelProps.isOptional(prop)

            if subModelName = @modelProps.getSubModelName(prop)
                value = @constructor.createModel(subModelName, value, options, @root)

            model.set(prop, value)


        # adding empty values to the model
        for prop in @modelProps.getAllProps()

            continue if model[prop]? or obj.hasOwnProperty prop

            continue if @modelProps.isId(prop)
            continue if @modelProps.isOptional(prop)

            defaultValue = @modelProps.getDefaultValue(prop)

            if subModelName = @modelProps.getSubModelName(prop)
                continue if @modelProps.isEntity(prop) # entity will be loaded at include() section

                model.set(prop, @constructor.createModel(subModelName, defaultValue, options, @root))

            else if defaultValue?
                switch typeof defaultValue
                    when &#x27;object&#x27;
                        defaultValue = Util.clone(defaultValue)
                    when &#x27;function&#x27;
                        defaultValue = defaultValue()

                model.set(prop, defaultValue)

            else
                model.set(prop, undefined)

        # loading entities by id
        if options.include isnt null # skip @include when null is set. By default it&#x27;s undefined, so @include will be executed
            @include(model, options.include).then (model) =&gt;
                if model.constructor.isImmutable
                    return model.freeze()
                else
                    return model

        # immutability
        else if model.constructor.isImmutable
            return model.freeze()

        return model


    ###*
    include submodels

    @method include
    @private
    @param {BaseModel} model
    @param {Object} [includeOptions]
    @param {Object} [includeOptions.async=false] include submodels asynchronously
    @param {Array(String)} [includeOptions.props] include submodels of given props
    ###
    include: (model, includeOptions = {}) -&gt;

        includeOptions.async ?= false

        return Promise.resolve(model) if not includeOptions

        return model.include includeOptions


    ###*
    create model list

    @method createList
    @public
    @param {String} listModelName model name of list
    @param {any} val
    @param {Object} [options]
    @param {Object} [options.include] options to pass to Includer
    @param {Object} [options.include.async=false] include sub-entities asynchronously if true.
    @param {Array(String)} [options.include.props] include sub-entities of given props
    @return {BaseList} list
    ###
    createList: (listModelName, val, options) -&gt; @createCollection listModelName, val, options


    ###*
    create model dict

    @method createDict
    @public
    @param {String} dictModelName model name of dict
    @param {any} val
    @param {Object} [options]
    @param {Object} [options.include] options to pass to Includer
    @param {Object} [options.include.async=false] include sub-entities asynchronously if true.
    @param {Array(String)} [options.include.props] include sub-entities of given props
    @return {BaseDict} dict
    ###
    createDict: (dictModelName, val, options) -&gt; @createCollection dictModelName, val, options


    ###*
    create collection

    @method createCollection
    @private
    @param {String} collModelName model name of collection
    @param {any} val
    @param {Object} [options]
    @return {BaseDict} dict
    ###
    createCollection: (collModelName, val, options) -&gt;

        return null if val is null

        val ?= []

        if Array.isArray val
            if typeof val[0] is &#x27;object&#x27;
                val = items: val
            else
                val = ids: val

        new GeneralFactory(collModelName, @root).createFromObject val, options


    ###*
    create an empty model

    @protected
    @return {BaseModel}
    ###
    create: -&gt;
        Model = @getModelClass()
        return new Model(null, @root)


module.exports = GeneralFactory

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
